import json

import pandas as pd

from utils import pheniqs

configfile: "config.yaml"

DATA = dict()

DATA["multiplex_units"] = (
    config["data"]["dir"] + 
    config["data"]["multiplex_units"])

DATA["multiplex_samples"] = (
    config["data"]["dir"] + 
    config["data"]["multiplex_samples"])

DATA["reference_genome"] = (
    config["data"]["dir"] + 
    config["data"]["reference_genome"])

units = pd.read_csv(DATA["multiplex_units"], index_col="id")

rule end:
    input:
        expand(
            config["data"]["dir"] + "{unit}_inter.cram",
            unit=units.index.values,),
        expand(
            "{unit}_demux.{suff}",
            unit=units.index.values,
            suff=["config.json", "report.json", "cram"]),
        expand(
            "{unit}_{mate}.fastq",
            unit=units.index.values,
            mate=["R1", "R2"]),
        expand(
            "{unit}_mapped.{suff}",
            unit=units.index.values,
            suff=[
                "noRG.bam",
                "bam", 
                "bam.bai",
                "mkdup.unsorted.bam",
                "mkdup.bam",
                "mkdup.bam.bai",
                "mkdup.flagstats.txt",
                "mkdup.stats.txt",
                "mkdup.idxstats.txt",
                "mkdup.qc.json.gz"]),

include: "rules/pheniqs_interleave.smk"
include: "rules/pheniqs_demultiplex_config.smk"
include: "rules/pheniqs_demultiplex.smk"
include: "rules/samtools_fastq.smk"
include: "rules/biscuit_align.smk"
include: "rules/samtools_reheader.smk"
include: "rules/samtools_index_pre.smk"
include: "rules/biscuit_markdup.smk"
include: "rules/samtools_sort.smk"
include: "rules/samtools_index_post.smk"
include: "rules/samtools_flagstats.smk"
include: "rules/samtools_stats.smk"
include: "rules/samtools_idxstats.smk"
include: "rules/alfred_qc.smk"
